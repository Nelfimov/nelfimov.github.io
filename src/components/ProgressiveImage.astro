---
import HEROES_LIST from '../assets/heroes.json'

const defaultPlaceholder = HEROES_LIST['800_low']
---

<img
  src={defaultPlaceholder}
  alt="profile"
  class="loading"
  data-progressive-image
/>

<script>
  const imgEl = document.querySelector('[data-progressive-image]')

  if (imgEl instanceof HTMLImageElement) {
    const resolveSources = () => {
      if (window.innerWidth >= 800) {
        return {
          placeholder: '/assets/hero/hero_800_low.jpg',
          full: '/assets/hero/hero_800.jpg',
        }
      }

      return {
        placeholder: '/assets/hero/hero_400_low.jpg',
        full: '/assets/hero/hero_400.jpg',
      }
    }

    const loadForViewport = () => {
      const { placeholder, full } = resolveSources()

      if (imgEl.src !== new URL(placeholder, window.location.origin).href) {
        imgEl.src = placeholder
      }
      imgEl.classList.remove('loaded')
      imgEl.classList.add('loading')

      const highResImage = new Image()
      highResImage.src = full
      highResImage.onload = () => {
        imgEl.src = full
        imgEl.classList.remove('loading')
        imgEl.classList.add('loaded')
      }
    }

    loadForViewport()
    window.addEventListener('resize', loadForViewport)
    window.addEventListener('load', loadForViewport)
  }
</script>
