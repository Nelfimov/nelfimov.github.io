---
import '../styles/About.css'
import ICONS_LIST from '../assets/icons.json'
import { getLangFromUrl, useTranslations } from '../i18n/utils.ts'
import { getCollection, render } from 'astro:content'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)

const pages = await getCollection('about')
const aboutDev = pages.find((page) => page.id === `${lang}/dev`)
const aboutDevOps = pages.find((page) => page.id === `${lang}/devops`)
const aboutHobby = pages.find((page) => page.id === `${lang}/hobby`)
const aboutPhilosophy = pages.find((page) => page.id === `${lang}/philosophy`)
const { Content: Philosophy } = aboutPhilosophy ? await render(aboutPhilosophy) : { Content: null }
const { Content: Dev } = aboutDev ? await render(aboutDev) : { Content: null }
const { Content: DevOps } = aboutDevOps ? await render(aboutDevOps) : { Content: null }
const { Content: Hobby } = aboutHobby ? await render(aboutHobby) : { Content: null }

const devItems = Object.values(ICONS_LIST.about.dev)
const devOpsItems = Object.values(ICONS_LIST.about.devops)
const toolsItems = Object.values(ICONS_LIST.about.tools)
---

<section class="about">
  <a class="nav-link" id="about"></a>
  <h1>{t('about.title')}</h1>
  <div data-about-observe>
    <div class="about-copy philosophy">
      <div>
        {Philosophy ? <Philosophy /> : null}
      </div>
    </div>
    <div class="about-copy dev">
      <div>
        {Dev ? <Dev /> : null}
      </div>
    </div>
    <div class="tech">
      {devItems.map((item) => (
        <div class="stack">
          <img
            src={item.src}
            alt={item.label}
            class="tech-icon"
          />
          <p class="tech-label">{item.label}</p>
        </div>
      ))}
    </div>
    <div class="tech">
      {devOpsItems.map((item) => (
        <div class="stack">
          <img
            src={item.src}
            alt={item.label}
            class="tech-icon"
          />
          <p class="tech-label">{item.label}</p>
        </div>
      ))}
    </div>
    <div class="about-copy devops">
      <div>
        {DevOps ? <DevOps /> : null}
      </div>
    </div>
    <div class="about-copy">
      <div>
        {Hobby ? <Hobby /> : null}
      </div>
    </div>
    <div class="tech">
      {toolsItems.map((item) => (
        <div class="stack">
          <img
            src={item.src}
            alt={item.label}
            class="tech-icon"
          />
          <p class="tech-label">{item.label}</p>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  const container = document.querySelector('[data-about-observe]')

  if (container) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active')
            observer.unobserve(entry.target)
          }
        })
      },
      {
        threshold: 0.4,
      }
    )

    const children = Array.from(container.children)
    children.forEach((child) => observer.observe(child))
  }
</script>
